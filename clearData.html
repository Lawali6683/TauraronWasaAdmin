<!DOCTYPE html>
<html lang="ha">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sake shiga | Kula da Bayanai</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        
        body {
    margin: 0;
    padding: 0;
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(to bottom, #180022, #300040);
    background-repeat: no-repeat;
    background-attachment: fixed;
    background-size: cover;
    color: #ffffff;
    transition: background 0.6s, color 0.6s;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
}

.container {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    padding: 20px;
    box-sizing: border-box;
}

.login-box {
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 40px;
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.18);
    width: 100%;
    max-width: 400px;
    text-align: center;
    animation: fadeIn 0.8s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
}

h1 {
    margin-bottom: 30px;
    font-size: 2.2em;
    font-weight: 600;
    color: #ffffff;
}

.input-group {
    margin-bottom: 20px;
    text-align: left;
}

.input-group label {
    display: block;
    margin-bottom: 8px;
    font-size: 0.9em;
    color: #e0e0e0;
}

.input-group input {
    width: 100%;
    padding: 12px 15px;
    border: none;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.15);
    color: #ffffff;
    font-size: 1em;
    box-sizing: border-box;
    transition: background 0.3s ease, box-shadow 0.3s ease;
}

.input-group input:focus {
    outline: none;
    background: rgba(255, 255, 255, 0.25);
    box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.4);
}

.input-group input::placeholder {
    color: #b0b0b0;
}

button {
    width: 100%;
    padding: 14px;
    background: linear-gradient(90deg, #6a11cb 0%, #2575fc 100%);
    border: none;
    border-radius: 8px;
    color: #ffffff;
    font-size: 1.1em;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    letter-spacing: 0.5px;
    text-transform: uppercase;
}

button:hover {
    background: linear-gradient(90deg, #2575fc 0%, #6a11cb 100%);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
}

button:active {
    transform: translateY(2px);
}

.notification-container {
    margin-top: 25px;
    padding: 15px;
    background-color: rgba(0, 0, 0, 0.3);
    border-radius: 8px;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.5s ease-out, visibility 0.5s ease-out;
    color: #ffffff;
    font-size: 0.9em;
}

.notification-container.show {
    opacity: 1;
    visibility: visible;
}

.notification-container.success {
    background-color: rgba(40, 167, 69, 0.5); 
}

.notification-container.error {
    background-color: rgba(220, 53, 69, 0.5); 
}


@media (max-width: 600px) {
    .login-box {
        padding: 30px 20px;
        margin: 0 15px;
    }
    h1 {
        font-size: 1.8em;
    }
    button {
        padding: 12px;
        font-size: 1em;
    }
}
    </style>
</head>
<body>
    <div class="container">
        <div class="login-box">
            <h1>Sake shiga</h1>
            <form id="loginForm">
                <div class="input-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" required autocomplete="username">
                </div>
                <div class="input-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" required autocomplete="current-password">
                </div>
                <button type="submit" id="loginBtn">login</button>
            </form>
            <div id="notificationContainer" class="notification-container">
                <p id="notificationMessage"></p>
            </div>
        </div>
    </div>

    <script type="module">
        
import { app, analytics } from './firebase.js'; 
import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
import { getDatabase, ref, get, remove } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

const auth = getAuth(app);
const db = getDatabase(app);

const loginForm = document.getElementById('loginForm');
const emailInput = document.getElementById('email');
const passwordInput = document.getElementById('password');
const notificationContainer = document.getElementById('notificationContainer');
const notificationMessage = document.getElementById('notificationMessage');


const TWENTY_DAYS_IN_MS = 20 * 24 * 60 * 60 * 1000;


function showNotification(message, isSuccess) {
    notificationMessage.textContent = message;
    notificationContainer.className = 'notification-container show';
    if (isSuccess) {
        notificationContainer.classList.add('success');
        notificationContainer.classList.remove('error');
    } else {
        notificationContainer.classList.add('error');
        notificationContainer.classList.remove('success');
    }
    setTimeout(() => {
        notificationContainer.classList.remove('show');
    }, 5000); 
}


function isImgurLink(url) {
    return url && url.includes('imgur.com');
}


function isChatbotLink(url) {   
    return url && url.includes('your_chatbot_domain.com');
}

function getImgurDeleteHash(imageUrl) {        
    console.warn("Lura: Don gogewa daga Imgur, dole ne ka adana 'deletehash' lokacin da ka loda hoton.");     
   
    const match = imageUrl.match(/\/([a-zA-Z0-9]+)(\.[a-zA-Z0-9]+)?$/);
    return match ? match[1] : null;
}


async function deleteFromImgur(deleteHash) {
    if (!deleteHash) {
        console.warn("Ba'a samu deleteHash na Imgur ba. Ba za a iya gogewa ba.");
        return false;
    }
    const clientId = "5acf7eff9c91660"; 
    try {
        const response = await fetch(`https://api.imgur.com/3/image/${deleteHash}`, {
            method: "DELETE",
            headers: {
                Authorization: `Client-ID ${clientId}`
            }
        });

        if (response.ok) {
            console.log(`An goge Imgur deleteHash: ${deleteHash}`);
            return true;
        } else {
            const errorData = await response.json();
            console.error(`Kuskure wajen gogewa daga Imgur (${deleteHash}):`, errorData);
            return false;
        }
    } catch (error) {
        console.error("Kuskure wajen gogewa daga Imgur:", error);
        return false;
    }
}


async function deleteFromChatbot(fileUrl) {          
    console.warn(`Gogewar chatbot bai cika ba. Idan chatbot dinka baya goyan bayan gogewa, zai ci gaba. Link: ${fileUrl}`);    
    return true;
}


async function handleExternalLinkDeletion(link) {
    if (!link) return;

    if (isImgurLink(link)) {
        const deleteHash = getImgurDeleteHash(link);
        if (deleteHash) {
            await deleteFromImgur(deleteHash);
        } else {
            console.warn(`Ba'a iya samun deletehash na Imgur don: ${link}. Ba za'a iya goge shi daga Imgur ba.`);
        }
    } else if (isChatbotLink(link)) {
        await deleteFromChatbot(link);
    }
}


async function cleanOldPosts() {
    let deletedPostCount = 0;
    let deletedCommentCount = 0;

    const currentTime = Date.now();
   
    try {
        const wasaniMasuZabiSnapshot = await get(ref(db, 'wasaniMasuZabi'));
        if (wasaniMasuZabiSnapshot.exists()) {
            const posts = wasaniMasuZabiSnapshot.val();
            for (const postId in posts) {
                const post = posts[postId];
                const postTime = post.PostTime;
                if (currentTime - postTime > TWENTY_DAYS_IN_MS) {
                    console.log(`Goge 'wasaniMasuZabi' post: ${postId}`);
                    await remove(ref(db, `wasaniMasuZabi/${postId}`));
                    deletedPostCount++;
               
                    const commentsSnapshot = await get(ref(db, 'wasaniMasuZabiComments'));
                    if (commentsSnapshot.exists()) {
                        const comments = commentsSnapshot.val();
                        for (const commentId in comments) {
                            const comment = comments[commentId];
                            if (comment.postCode === postId) {
                                console.log(`Goge 'wasaniMasuZabiComments' comment: ${commentId} for post ${postId}`);
                                await remove(ref(db, `wasaniMasuZabiComments/${commentId}`));
                                deletedCommentCount++;
                               
                                await handleExternalLinkDeletion(comment.imageLink);
                                await handleExternalLinkDeletion(comment.audioLink);

                                if (comment.reply && Array.isArray(comment.reply)) {
                                    for (const reply of comment.reply) {
                                        await handleExternalLinkDeletion(reply.imageLink);
                                        await handleExternalLinkDeletion(reply.audioLink);
                                    }
                                }
                            }
                        }
                    }
                    
                    await handleExternalLinkDeletion(post.photalinlink);
                    await handleExternalLinkDeletion(post.audioLink);
                }
            }
        }
    } catch (error) {
        console.error("Kuskure wajen goge 'wasaniMasuZabi':", error);
        showNotification("An samu kuskure wajen goge tsoffin wasanni.", false);
        return;
    }

   
    try {
        const postingSnapshot = await get(ref(db, 'Posting'));
        if (postingSnapshot.exists()) {
            const posts = postingSnapshot.val();
            for (const postId in posts) {
                const post = posts[postId];
                const postTime = post.postingTime; 
                if (currentTime - postTime > TWENTY_DAYS_IN_MS) {
                    console.log(`Goge 'Posting' post: ${postId}`);
                    await remove(ref(db, `Posting/${postId}`));
                    deletedPostCount++;

                   
                    const commentsSnapshot = await get(ref(db, 'PostingComments'));
                    if (commentsSnapshot.exists()) {
                        const comments = commentsSnapshot.val();
                        for (const commentId in comments) {
                            const comment = comments[commentId];
                            if (comment.postid === postId) {
                                console.log(`Goge 'PostingComments' comment: ${commentId} for post ${postId}`);
                                await remove(ref(db, `PostingComments/${commentId}`));
                                deletedCommentCount++;

                                
                                await handleExternalLinkDeletion(comment.imageLink);
                                await handleExternalLinkDeletion(comment.commentAudioLink);

                                if (comment.reply && Array.isArray(comment.reply)) {
                                    for (const reply of comment.reply) {
                                        await handleExternalLinkDeletion(reply.imageLink);
                                        await handleExternalLinkDeletion(reply.replyAudioLink);
                                    }
                                }
                            }
                        }
                    }
                   
                    await handleExternalLinkDeletion(post.photoLink1);
                    await handleExternalLinkDeletion(post.photoLink2);
                    await handleExternalLinkDeletion(post.videoLink);
                    await handleExternalLinkDeletion(post.audioLink);
                    await handleExternalLinkDeletion(post.tauraronwasaAudiolink);
                }
            }
        }
    } catch (error) {
        console.error("Kuskure wajen goge 'Posting':", error);
        showNotification("An samu kuskure wajen goge tsoffin labarai.", false);
        return;
    }

    if (deletedPostCount > 0 || deletedCommentCount > 0) {
        showNotification(`An yi nasarar goge posts ${deletedPostCount} da comments ${deletedCommentCount}.`, true);
    } else {
        showNotification("Babu wani post da ya wuce kwana 20 da za a goge.", true);
    }
}

loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = emailInput.value;
    const password = passwordInput.value;

    try {
        await signInWithEmailAndPassword(auth, email, password);
        console.log("An yi nasarar shiga!");
        showNotification("An yi nasarar shiga. Yanzu ana goge tsoffin bayanai...", true);
        loginForm.style.display = 'none'; 
        await cleanOldPosts(); 
    } catch (error) {
        console.error("Kuskure wajen shiga:", error.message);
        showNotification(`Kuskure wajen shiga: ${error.message}`, false);
    }
});
    </script>
</body>
</html>
