<!DOCTYPE html>
<html lang="ha">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sake shiga | Kula da Bayanai</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        
        body {
    margin: 0;
    padding: 0;
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(to bottom, #180022, #300040);
    background-repeat: no-repeat;
    background-attachment: fixed;
    background-size: cover;
    color: #ffffff;
    transition: background 0.6s, color 0.6s;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
}

.container {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    padding: 20px;
    box-sizing: border-box;
}

.login-box {
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 40px;
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.18);
    width: 100%;
    max-width: 400px;
    text-align: center;
    animation: fadeIn 0.8s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
}

h1 {
    margin-bottom: 30px;
    font-size: 2.2em;
    font-weight: 600;
    color: #ffffff;
}

.input-group {
    margin-bottom: 20px;
    text-align: left;
}

.input-group label {
    display: block;
    margin-bottom: 8px;
    font-size: 0.9em;
    color: #e0e0e0;
}

.input-group input {
    width: 100%;
    padding: 12px 15px;
    border: none;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.15);
    color: #ffffff;
    font-size: 1em;
    box-sizing: border-box;
    transition: background 0.3s ease, box-shadow 0.3s ease;
}

.input-group input:focus {
    outline: none;
    background: rgba(255, 255, 255, 0.25);
    box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.4);
}

.input-group input::placeholder {
    color: #b0b0b0;
}

button {
    width: 100%;
    padding: 14px;
    background: linear-gradient(90deg, #6a11cb 0%, #2575fc 100%);
    border: none;
    border-radius: 8px;
    color: #ffffff;
    font-size: 1.1em;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    letter-spacing: 0.5px;
    text-transform: uppercase;
}

button:hover {
    background: linear-gradient(90deg, #2575fc 0%, #6a11cb 100%);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
}

button:active {
    transform: translateY(2px);
}

.notification-container {
    margin-top: 25px;
    padding: 15px;
    background-color: rgba(0, 0, 0, 0.3);
    border-radius: 8px;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.5s ease-out, visibility 0.5s ease-out;
    color: #ffffff;
    font-size: 0.9em;
}

.notification-container.show {
    opacity: 1;
    visibility: visible;
}

.notification-container.success {
    background-color: rgba(40, 167, 69, 0.5); /* Green for success */
}

.notification-container.error {
    background-color: rgba(220, 53, 69, 0.5); /* Red for error */
}

/* Responsive adjustments */
@media (max-width: 600px) {
    .login-box {
        padding: 30px 20px;
        margin: 0 15px;
    }
    h1 {
        font-size: 1.8em;
    }
    button {
        padding: 12px;
        font-size: 1em;
    }
}
    </style>
</head>
<body>
    <div class="container">
        <div class="login-box">
            <h1>Sake shiga</h1>
            <form id="loginForm">
                <div class="input-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" required autocomplete="username">
                </div>
                <div class="input-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" required autocomplete="current-password">
                </div>
                <button type="submit" id="loginBtn">login</button>
            </form>
            <div id="notificationContainer" class="notification-container">
                <p id="notificationMessage"></p>
            </div>
        </div>
    </div>

    <script type="module">
        // Alamar farkon site: JavaScript Logic
import { app, analytics } from './firebase.js'; // firebase.js din ku
import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
import { getDatabase, ref, get, remove } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

const auth = getAuth(app);
const db = getDatabase(app);

const loginForm = document.getElementById('loginForm');
const emailInput = document.getElementById('email');
const passwordInput = document.getElementById('password');
const notificationContainer = document.getElementById('notificationContainer');
const notificationMessage = document.getElementById('notificationMessage');

// Kwana 20 a milliseconds
const TWENTY_DAYS_IN_MS = 20 * 24 * 60 * 60 * 1000;

/**
 * Nuna sanarwa ga mai amfani.
 * @param {string} message - Saƙon da za a nuna.
 * @param {boolean} isSuccess - Gaskiya idan saƙo ne na nasara, kuskure idan ba haka ba.
 */
function showNotification(message, isSuccess) {
    notificationMessage.textContent = message;
    notificationContainer.className = 'notification-container show';
    if (isSuccess) {
        notificationContainer.classList.add('success');
        notificationContainer.classList.remove('error');
    } else {
        notificationContainer.classList.add('error');
        notificationContainer.classList.remove('success');
    }
    setTimeout(() => {
        notificationContainer.classList.remove('show');
    }, 5000); // Boye bayan seconds 5
}

/**
 * Gwada idan link din hoto ko audio na Imgur ne.
 * @param {string} url - Link din da za a bincika.
 * @returns {boolean}
 */
function isImgurLink(url) {
    return url && url.includes('imgur.com');
}

/**
 * Gwada idan link din hoto ko audio na Chatbot ne.
 * @param {string} url - Link din da za a bincika.
 * @returns {boolean}
 */
function isChatbotLink(url) {
    // Ka saka URL din chatbot dinka anan
    return url && url.includes('your_chatbot_domain.com');
}

/**
 * Neman Imgur deletehash daga URL.
 * Imgur yana amfani da deletehash don gogewa, wanda yake daban da image ID.
 * Da alama deletehash ba'a nuna shi a cikin URL na hoton da aka loda ba.
 * Wannan aikin yana buƙatar ka adana deletehash lokacin da aka fara lodawa zuwa Imgur.
 * A saboda wannan, idan ba ka adana deletehash ba, gogewar Imgur za ta gagara.
 * Don tsaron data, ba za mu yi yunkurin gogewa ba tare da tabbacin deletehash ba.
 * Za'a buƙaci API na Imgur don gogewa.
 * Ga misalin yadda Imgur ke buƙatar gogewa: DELETE /3/image/{deleteHash}
 * https://apidocs.imgur.com/#c85c9060-577d-495d-9c3c-24f068597167
 *
 * A matsayin mafita mai sauƙi, za mu iya amfani da image ID idan har Imgur API yana goyan bayan hakan.
 * Amma bisa ga takardunsu, DELETEHASH ake buƙata.
 * Idan ba ka da deletehash a cikin data, gogewar Imgur ba zai yiwu ba ta hanyar API.
 * Wannan aikin zai zama "placeholder" idan har ba'a adana deletehash ba.
 * Ya kamata ka adana 'deletehash' a cikin Firebase lokacin da aka loda hoto zuwa Imgur.
 *
 * @param {string} imageUrl - Link din hoton Imgur.
 * @returns {string|null} - Deletehash ko null idan ba'a samu ba.
 */
function getImgurDeleteHash(imageUrl) {
    // Misali: Idan deletehash yana cikin URL (wanda bai fi faruwa ba) ko wata alama ce
    // Saboda Imgur yana buƙatar DELETE request zuwa /image/{deleteHash} ba ID ba,
    // dole ne ka adana deleteHash a cikin data ɗinka lokacin da ka loda hoton.
    // Idan ba ka adana shi ba, wannan aikin ba zai iya nemo shi ba kuma gogewar Imgur za ta gagara.
    console.warn("Lura: Don gogewa daga Imgur, dole ne ka adana 'deletehash' lokacin da ka loda hoton.");
    // Idan ka adana deletehash a cikin data, zaka iya ciro shi daga can.
    // Misali, idan URL din yana da query parameter "deletehash=XYZ", za ka iya ciro shi.
    // A halin yanzu, mun dawo da ID kawai wanda bai isa ba don gogewa.
    const match = imageUrl.match(/\/([a-zA-Z0-9]+)(\.[a-zA-Z0-9]+)?$/);
    return match ? match[1] : null; // Wannan ID ne, ba deletehash ba.
}

/**
 * Goge hoto ko audio daga Imgur.
 * @param {string} deleteHash - Hash din gogewa daga Imgur.
 * @returns {Promise<boolean>}
 */
async function deleteFromImgur(deleteHash) {
    if (!deleteHash) {
        console.warn("Ba'a samu deleteHash na Imgur ba. Ba za a iya gogewa ba.");
        return false;
    }
    const clientId = "5acf7eff9c91660"; // Client-ID dinka na Imgur
    try {
        const response = await fetch(`https://api.imgur.com/3/image/${deleteHash}`, {
            method: "DELETE",
            headers: {
                Authorization: `Client-ID ${clientId}`
            }
        });

        if (response.ok) {
            console.log(`An goge Imgur deleteHash: ${deleteHash}`);
            return true;
        } else {
            const errorData = await response.json();
            console.error(`Kuskure wajen gogewa daga Imgur (${deleteHash}):`, errorData);
            return false;
        }
    } catch (error) {
        console.error("Kuskure wajen gogewa daga Imgur:", error);
        return false;
    }
}

/**
 * Goge hoto ko audio daga Chatbot.
 * @param {string} fileUrl - Link din fayil din da za a goge.
 * @returns {Promise<boolean>}
 */
async function deleteFromChatbot(fileUrl) {
    // Tsarin gogewa na chatbot ya dogara da API din chatbot dinka.
    // Idan chatbot dinka yana da API na gogewa, ka sanya shi anan.
    // Misali:
    // try {
    //     const response = await fetch('https://your_chatbot_api.com/delete_file', {
    //         method: 'POST',
    //         headers: {
    //             'Content-Type': 'application/json',
    //             'Authorization': 'Bearer YOUR_CHATBOT_API_KEY'
    //         },
    //         body: JSON.stringify({ fileUrl: fileUrl })
    //     });
    //     if (response.ok) {
    //         console.log(`An goge fayil daga chatbot: ${fileUrl}`);
    //         return true;
    //     } else {
    //         const errorData = await response.json();
    //         console.error(`Kuskure wajen gogewa daga chatbot (${fileUrl}):`, errorData);
    //         return false;
    //     }
    // } catch (error) {
    //     console.error("Kuskure wajen gogewa daga chatbot:", error);
    //     return false;
    // }

    console.warn(`Gogewar chatbot bai cika ba. Idan chatbot dinka baya goyan bayan gogewa, zai ci gaba. Link: ${fileUrl}`);
    // Idan chatbot bashi da API na gogewa, kawai mayar da gaskiya domin a ci gaba.
    return true;
}

/**
 * Bincika da goge link na waje (Imgur, Chatbot).
 * @param {string|null} link - Link din da za a bincika.
 */
async function handleExternalLinkDeletion(link) {
    if (!link) return;

    if (isImgurLink(link)) {
        const deleteHash = getImgurDeleteHash(link);
        if (deleteHash) {
            await deleteFromImgur(deleteHash);
        } else {
            console.warn(`Ba'a iya samun deletehash na Imgur don: ${link}. Ba za'a iya goge shi daga Imgur ba.`);
        }
    } else if (isChatbotLink(link)) {
        await deleteFromChatbot(link);
    }
}

/**
 * Bincika da goge tsoffin posts da comments.
 */
async function cleanOldPosts() {
    let deletedPostCount = 0;
    let deletedCommentCount = 0;

    const currentTime = Date.now();

    // --- Goge daga "wasaniMasuZabi" da "wasaniMasuZabiComments" ---
    try {
        const wasaniMasuZabiSnapshot = await get(ref(db, 'wasaniMasuZabi'));
        if (wasaniMasuZabiSnapshot.exists()) {
            const posts = wasaniMasuZabiSnapshot.val();
            for (const postId in posts) {
                const post = posts[postId];
                const postTime = post.PostTime; // Timestamp in milliseconds
                if (currentTime - postTime > TWENTY_DAYS_IN_MS) {
                    console.log(`Goge 'wasaniMasuZabi' post: ${postId}`);
                    await remove(ref(db, `wasaniMasuZabi/${postId}`));
                    deletedPostCount++;

                    // Goge comments da replies da ke da alaƙa
                    const commentsSnapshot = await get(ref(db, 'wasaniMasuZabiComments'));
                    if (commentsSnapshot.exists()) {
                        const comments = commentsSnapshot.val();
                        for (const commentId in comments) {
                            const comment = comments[commentId];
                            if (comment.postCode === postId) {
                                console.log(`Goge 'wasaniMasuZabiComments' comment: ${commentId} for post ${postId}`);
                                await remove(ref(db, `wasaniMasuZabiComments/${commentId}`));
                                deletedCommentCount++;

                                // Bincika links a cikin comments da replies
                                await handleExternalLinkDeletion(comment.imageLink);
                                await handleExternalLinkDeletion(comment.audioLink);

                                if (comment.reply && Array.isArray(comment.reply)) {
                                    for (const reply of comment.reply) {
                                        await handleExternalLinkDeletion(reply.imageLink);
                                        await handleExternalLinkDeletion(reply.audioLink);
                                    }
                                }
                            }
                        }
                    }
                    // Bincika links a cikin babban post
                    await handleExternalLinkDeletion(post.photalinlink);
                    await handleExternalLinkDeletion(post.audioLink);
                }
            }
        }
    } catch (error) {
        console.error("Kuskure wajen goge 'wasaniMasuZabi':", error);
        showNotification("An samu kuskure wajen goge tsoffin wasanni.", false);
        return;
    }

    // --- Goge daga "Posting" da "PostingComments" ---
    try {
        const postingSnapshot = await get(ref(db, 'Posting'));
        if (postingSnapshot.exists()) {
            const posts = postingSnapshot.val();
            for (const postId in posts) {
                const post = posts[postId];
                const postTime = post.postingTime; // Timestamp in milliseconds
                if (currentTime - postTime > TWENTY_DAYS_IN_MS) {
                    console.log(`Goge 'Posting' post: ${postId}`);
                    await remove(ref(db, `Posting/${postId}`));
                    deletedPostCount++;

                    // Goge comments da replies da ke da alaƙa
                    const commentsSnapshot = await get(ref(db, 'PostingComments'));
                    if (commentsSnapshot.exists()) {
                        const comments = commentsSnapshot.val();
                        for (const commentId in comments) {
                            const comment = comments[commentId];
                            if (comment.postid === postId) {
                                console.log(`Goge 'PostingComments' comment: ${commentId} for post ${postId}`);
                                await remove(ref(db, `PostingComments/${commentId}`));
                                deletedCommentCount++;

                                // Bincika links a cikin comments da replies
                                await handleExternalLinkDeletion(comment.imageLink);
                                await handleExternalLinkDeletion(comment.commentAudioLink);

                                if (comment.reply && Array.isArray(comment.reply)) {
                                    for (const reply of comment.reply) {
                                        await handleExternalLinkDeletion(reply.imageLink);
                                        await handleExternalLinkDeletion(reply.replyAudioLink);
                                    }
                                }
                            }
                        }
                    }
                    // Bincika links a cikin babban post
                    await handleExternalLinkDeletion(post.photoLink1);
                    await handleExternalLinkDeletion(post.photoLink2);
                    await handleExternalLinkDeletion(post.videoLink);
                    await handleExternalLinkDeletion(post.audioLink);
                    await handleExternalLinkDeletion(post.tauraronwasaAudiolink);
                }
            }
        }
    } catch (error) {
        console.error("Kuskure wajen goge 'Posting':", error);
        showNotification("An samu kuskure wajen goge tsoffin labarai.", false);
        return;
    }

    if (deletedPostCount > 0 || deletedCommentCount > 0) {
        showNotification(`An yi nasarar goge posts ${deletedPostCount} da comments ${deletedCommentCount}.`, true);
    } else {
        showNotification("Babu wani post da ya wuce kwana 20 da za a goge.", true);
    }
}

// Sarrafa shiga (Login)
loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = emailInput.value;
    const password = passwordInput.value;

    try {
        await signInWithEmailAndPassword(auth, email, password);
        console.log("An yi nasarar shiga!");
        showNotification("An yi nasarar shiga. Yanzu ana goge tsoffin bayanai...", true);
        loginForm.style.display = 'none'; // Boye fom din shiga bayan shiga
        await cleanOldPosts(); // Kira aikin gogewa bayan nasarar shiga
    } catch (error) {
        console.error("Kuskure wajen shiga:", error.message);
        showNotification(`Kuskure wajen shiga: ${error.message}`, false);
    }
});
    </script>
</body>
</html>