<!DOCTYPE html>
<html lang="ha">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Agents - TauraronWasa</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css?family=Poppins:400,600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="agents.css">
  <style>
      body {
  margin: 0;
  padding: 0;
  font-family: 'Poppins', sans-serif;
  background: linear-gradient(to bottom, #180022, #300040);
  background-repeat: no-repeat;
  background-attachment: fixed;
  background-size: cover;
  color: #fff;
  min-height: 100vh;
}

#preloader {
  position: fixed;
  top:0; left:0; right:0; bottom:0;
  background: rgba(24,0,34,0.9);
  z-index: 2000;
  display: flex;
  align-items: center;
  justify-content: center;
}
.loader {
  border: 6px solid #fff;
  border-top: 6px solid #7c31ff;
  border-radius: 50%;
  width: 60px; height: 60px;
  animation: spin 1.1s linear infinite;
}
@keyframes spin {
  to { transform: rotate(360deg);}
}

.centered-section {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 90vh;
}
.login-container {
  background: rgba(39, 11, 64, 0.92);
  border-radius: 14px;
  padding: 2.5rem 2rem 2rem;
  box-shadow: 0 6px 32px #0006;
  width: 95vw;
  max-width: 370px;
  text-align: center;
}
.login-container h2 {
  margin-bottom: 1rem;
  font-weight: 600;
}
.input-group {
  margin-bottom: 1.1rem;
  text-align: left;
}
.input-group label {
  font-size: 0.98rem;
  font-weight: 500;
  margin-bottom: .25rem;
  display: block;
}
.input-group input, 
.input-group textarea {
  width: 100%;
  padding: 10px 13px;
  border-radius: 8px;
  border: none;
  margin-top: 3px;
  font-family: inherit;
  font-size: 1rem;
  background: #300040;
  color: #fff;
  outline: none;
  transition: box-shadow 0.2s;
}
.input-group input:focus, .input-group textarea:focus {
  box-shadow: 0 0 0 2px #7c31ff;
}
.input-group textarea {
  min-height: 60px;
  resize: vertical;
}
.main-btn {
  background: linear-gradient(90deg, #7c31ff, #9a42ff);
  color: #fff;
  border: none;
  padding: 12px 26px;
  border-radius: 7px;
  font-size: 1rem;
  font-weight: 600;
  transition: background .2s, box-shadow .2s;
  cursor: pointer;
  box-shadow: 0 3px 12px #0002;
}
.main-btn:hover {
  background: #7c31ff;
  box-shadow: 0 6px 32px #7c31ff22;
}
.icon-btn {
  background: transparent;
  border: none;
  color: #fff;
  font-size: 1.4rem;
  cursor: pointer;
  padding: 0 7px;
  vertical-align: middle;
}
header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 2.5vw 4vw 1vw 4vw;
  background: rgba(39, 11, 64, 0.97);
  box-shadow: 0 2px 14px #0002;
  position: sticky;
  top: 0;
  z-index: 100;
}
header h1 {
  font-size: 1.5rem;
  font-weight: 600;
}
#welcomeMsg {
  font-size: 1.08rem;
  margin-left: 1.2rem;
  color: #7c31ff;
  font-weight: 500;
}
.action-bar {
  display: flex;
  align-items: center;
  gap: 2vw;
  padding: 1vw 4vw;
  margin-bottom: 1.5vw;
}
.api-links a {
  color: #9a42ff;
  margin-left: 12px;
  font-size: 1.2rem;
  text-decoration: none;
  transition: color .15s;
}
.api-links a:hover {
  color: #fff;
}
#dashboardSection {
  max-width: 900px;
  margin: 0 auto;
  padding-bottom: 2rem;
}
.hidden { display: none; }

.news-feed {
  margin: 1.5rem 0;
  display: flex;
  flex-direction: column;
  gap: 1.3rem;
}
.news-card, .post-card {
  background: rgba(48, 0, 64, 0.96);
  border-radius: 11px;
  padding: 1.1rem 1.2rem 0.8rem;
  box-shadow: 0 2px 12px #0002;
  transition: transform .19s;
  display: flex;
  flex-direction: column;
  position: relative;
  animation: fadeUp .7s;
}
@keyframes fadeUp {
  from { opacity: 0; transform: translateY(25px);}
  to   { opacity: 1; transform: translateY(0);}
}
.news-card .news-title, .post-card .post-title {
  font-size: 1.14rem;
  font-weight: 600;
  color: #f1c40f;
}
.news-content, .post-content {
  margin: 0.7rem 0 0.6rem 0;
  color: #fff;
  font-size: 1.01rem;
}
.news-image, .post-image, .post-video {
  width: 100%;
  max-height: 210px;
  object-fit: cover;
  border-radius: 5px;
  margin-bottom: 0.65rem;
  background: #260036;
}
.news-meta, .post-meta {
  display: flex;
  align-items: center;
  gap: 0.9rem;
  font-size: 0.92rem;
  color: #b2a0e6;
  margin-bottom: 0.7rem;
}
.post-actions {
  display: flex;
  gap: 13px;
  justify-content: flex-end;
  margin-top: 0.5rem;
  margin-bottom: .3rem;
}
.post-actions button {
  background: none;
  border: none;
  color: #fff;
  font-size: 1.08rem;
  padding: 6px 10px;
  margin-left: 6px;
  border-radius: 5px;
  cursor: pointer;
  transition: background .16s, color .16s;
}
.post-actions button:hover {
  background: #7c31ff18;
  color: #f1c40f;
}
.editing .post-content, .editing .post-title {
  border: 1px solid #7c31ff;
  border-radius: 5px;
  padding: 6px;
  background: #2d003e;
  color: #fff;
}
.editing .post-content[contenteditable="true"], .editing .post-title[contenteditable="true"] {
  outline: 2px solid #7c31ff;
}
.editing .save-edit-btn {
  background: linear-gradient(90deg, #7c31ff, #9a42ff);
  color: #fff;
  font-weight: bold;
  border: none;
  border-radius: 5px;
  margin-left: 10px;
  padding: 6px 14px;
  cursor: pointer;
}
#pushNotificationContainer {
  position: fixed;
  bottom: 28px;
  right: 28px;
  z-index: 3000;
  display: flex;
  flex-direction: column;
  gap: 14px;
  pointer-events: none;
}
.push-notification {
  min-width: 200px;
  padding: 13px 19px;
  background: #260036;
  color: #fff;
  border-left: 6px solid #9a42ff;
  border-radius: 7px;
  box-shadow: 0 2px 18px #0005;
  font-size: 1rem;
  opacity: 0.95;
  animation: fadeIn .5s;
  pointer-events: auto;
  display: flex;
  align-items: center;
  gap: 8px;
}
.push-notification.success { border-color: #27ae60; }
.push-notification.error { border-color: #e74c3c; }
.push-notification .fa-xmark { margin-left: auto; cursor: pointer; color: #fff9; font-size: 1.1rem;}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(13px);}
  to   { opacity: 0.95; transform: translateY(0);}
}

#newPostForm, #createPostSection {
  background: rgba(48, 0, 64, 0.96);
  border-radius: 11px;
  box-shadow: 0 2px 12px #0002;
  padding: 1.3rem 1.2rem;
  margin-bottom: 1.7rem;
  max-width: 670px;
  width: 100%;
}
#newPostForm h2, #createPostSection h2 {
  font-size: 1.18rem;
  margin-bottom: 1rem;
  color: #f1c40f;
}
.media-upload {
  display: flex;
  flex-direction: column;
  gap: 7px;
}
.uploaded-images, .uploaded-videos {
  display: flex;
  gap: 9px;
  margin-top: 5px;
}
.upload-thumb, .video-thumb {
  width: 70px;
  height: 70px;
  object-fit: cover;
  border-radius: 8px;
  position: relative;
  background: #1e0030;
  border: 1.5px solid #7c31ff;
}
.upload-thumb .remove-media, .video-thumb .remove-media {
  position: absolute;
  top: 4px; right: 4px;
  background: rgba(30,0,48,.7);
  color: #f1c40f;
  border: none;
  border-radius: 50%;
  width: 22px; height: 22px;
  font-size: 1rem;
  cursor: pointer;
  display: flex;
  align-items: center; justify-content: center;
  z-index: 2;
}
@media (max-width: 700px) {
  header, .action-bar { padding: 3vw 1vw;}
  #dashboardSection { padding-left: 1vw; padding-right: 1vw;}
  .news-feed, #firebasePosts { gap: 0.8rem;}
  .news-card, .post-card { padding: 0.7rem 0.6rem;}
}
@media (max-width: 450px) {
  .login-container { padding: 1.2rem 0.8rem;}
  #newPostForm, #createPostSection { padding: 0.7rem 0.4rem;}
}
  </style>
</head>
<body>
  <!-- Preloader -->
  <div id="preloader">
    <div class="loader"></div>
  </div>

  <!-- Push Notification Container -->
  <div id="pushNotificationContainer"></div>

  <!-- Login Form -->
  <div id="loginSection" class="centered-section">
    <div class="login-container">
      <h2>Shiga Agents</h2>
      <form id="loginForm">
        <div class="input-group">
          <label for="email"><i class="fas fa-envelope"></i> Imel</label>
          <input type="email" id="email" required placeholder="Shigar da imel...">
        </div>
        <div class="input-group">
          <label for="password"><i class="fas fa-lock"></i> Kalmar sirri</label>
          <input type="password" id="password" required placeholder="Shigar da kalmar sirri...">
        </div>
        <button type="submit" class="main-btn">Shiga</button>
      </form>
    </div>
  </div>

  <!-- Main Dashboard -->
  <div id="dashboardSection" class="hidden">
    <header>
      <h1>Agents TauraronWasa</h1>
      <span id="welcomeMsg"></span>
      <button id="logoutBtn" title="Fita" class="icon-btn"><i class="fas fa-sign-out-alt"></i></button>
    </header>
    <div class="action-bar">
      <button id="fetchNewsBtn" class="main-btn"><i class="fas fa-newspaper"></i> Labaran Wasanni na duniya</button>
      <span class="api-links">
        <a href="https://www.skysports.com/football/news" target="_blank" title="Sky Sports"><i class="fas fa-futbol"></i></a>
        <a href="https://www.bbc.com/sport/football" target="_blank" title="BBC Sport"><i class="fas fa-futbol"></i></a>
        <a href="https://www.sportskeeda.com/go/football" target="_blank" title="Sportskeeda"><i class="fas fa-futbol"></i></a>
      </span>
    </div>
    <section id="newsFeed" class="news-feed"></section>

    <!-- Create Post Form -->
    <section id="createPostSection">
      <h2><i class="fas fa-pen"></i> Kirkiri Sabon Post</h2>
      <form id="newPostForm">
        <div class="input-group">
          <label for="postTitle"><i class="fas fa-heading"></i> Taken Post</label>
          <input type="text" id="postTitle" maxlength="80" required placeholder="Shigar da taken post...">
        </div>
        <div class="input-group">
          <label for="postText"><i class="fas fa-align-left"></i> Rubutun Post</label>
          <textarea id="postText" required placeholder="Rubuta cikakken labari..."></textarea>
        </div>
        <div class="input-group media-upload">
          <label><i class="fas fa-image"></i> Hoton Post</label>
          <input type="file" id="imageUpload1" accept="image/*">
          <input type="file" id="imageUpload2" accept="image/*">
          <div class="uploaded-images" id="uploadedImages"></div>
        </div>
        <div class="input-group media-upload">
          <label><i class="fas fa-video"></i> Bidiyo (9MB Max)</label>
          <input type="file" id="videoUpload" accept="video/*">
          <div class="uploaded-videos" id="uploadedVideos"></div>
        </div>
        <div class="input-group">
          <label for="mediaLink"><i class="fas fa-link"></i> Link na Hoto/Bidiyo (Zabi)</label>
          <input type="url" id="mediaLink" placeholder="Saka link din hoto ko bidiyo...">
        </div>
        <button type="submit" class="main-btn"><i class="fas fa-paper-plane"></i> Tura Post</button>
      </form>
    </section>
    <!-- End Create Post Form -->

    <section id="firebasePosts" class="news-feed"></section>
  </div>

  <script type="module">
            
import { app, analytics, firebaseConfig } from './firebase.js';
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
import { getDatabase, ref, get, set, push, update, remove, child, onValue } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

const allowedEmails = [
  "harunalawali5522@gmail.com",
  "lawaliharuna943@gmail.com",
  "tauraronwasa@gmil.com"
];
const newsRSSLinks = [
  "https://www.skysports.com/rss/12040",
  "http://feeds.bbci.co.uk/sport/football/rss.xml",
  "https://www.sportskeeda.com/rss/football"
];
const newsAPILinks = [
  { name: "Sky Sports", url: "https://www.skysports.com/football/news" },
  { name: "BBC Sport", url: "https://www.bbc.com/sport/football" },
  { name: "Sportskeeda", url: "https://www.sportskeeda.com/go/football" }
];

// ==== UI ELEMENTS ====
const preloader = document.getElementById('preloader');
const pushContainer = document.getElementById('pushNotificationContainer');
const loginSection = document.getElementById('loginSection');
const dashboardSection = document.getElementById('dashboardSection');
const loginForm = document.getElementById('loginForm');
const fetchNewsBtn = document.getElementById('fetchNewsBtn');
const newsFeed = document.getElementById('newsFeed');
const firebasePosts = document.getElementById('firebasePosts');
const welcomeMsg = document.getElementById('welcomeMsg');
const logoutBtn = document.getElementById('logoutBtn');
const newPostForm = document.getElementById('newPostForm');
const uploadedImages = document.getElementById('uploadedImages');
const uploadedVideos = document.getElementById('uploadedVideos');

// ==== GLOBAL STATE ====
let currentUser = null;
let currentFullName = '';
let currentUID = '';
let lastFetchTimestamp = null;
let images = [];
let videos = [];
let editingPostId = null;

// ==== HELPER FUNCTIONS ====

// Preloader
function showPreloader() { preloader.style.display = 'flex'; }
function hidePreloader() { preloader.style.display = 'none'; }
showPreloader();

// push notifications 
function pushNotification(msg, type = 'success', duration = 4200) {
  const note = document.createElement('div');
  note.className = `push-notification ${type}`;
  note.innerHTML = `<span>${msg}</span><i class="fas fa-xmark"></i>`;
  pushContainer.appendChild(note);
  note.querySelector('.fa-xmark').onclick = () => note.remove();
  setTimeout(() => { note.remove(); }, duration);
}

// Date to Nigeria Time
function toNigeriaTime(date = new Date()) {
  // Nigeria is UTC+1, handle daylight
  const utc = date.getTime() + (date.getTimezoneOffset() * 60000);
  return new Date(utc + (3600000));
}

// Format date for posts
function formatDate(dt) {
  const d = typeof dt === "string" ? new Date(dt) : dt;
  return d.toLocaleString("ha-NG", { hour12: false });
}

// Validate video size (<9MB)
function isValidVideoSize(file) {
  return file.size <= 9 * 1024 * 1024;
}

// Generate a random post id
function generateShortId(len = 8) {
  let chars = "ABCDEFKGHLMNPQRSTUVWXYZ23456789";
  let id = '';
  for (let i = 0; i < len; i++) id += chars[Math.floor(Math.random()*chars.length)];
  return id;
}

// ==== AUTHENTICATION LOGIC ====
const auth = getAuth(app);
const db = getDatabase(app);

onAuthStateChanged(auth, async (user) => {
  if(user && allowedEmails.includes(user.email)) {
    currentUser = user;
    currentUID = user.uid;
    loginSection.classList.add('hidden');
    dashboardSection.classList.remove('hidden');
    // Load fullName from DB
    const userRef = ref(db, 'users/' + currentUID);
    let snap = await get(userRef);
    if(snap.exists() && snap.val().fullName) {
      currentFullName = snap.val().fullName;
    } else {
      currentFullName = user.email.split('@')[0];
      set(userRef, { fullName: currentFullName });
    }
    welcomeMsg.innerHTML = `Barka da zuwa Agents <b>${currentFullName}</b>`;
    hidePreloader();
    fetchPosts();
  } else {
    dashboardSection.classList.add('hidden');
    loginSection.classList.remove('hidden');
    hidePreloader();
  }
});

loginForm.onsubmit = async (e) => {
  e.preventDefault();
  showPreloader();
  const email = loginForm.email.value.trim();
  const password = loginForm.password.value.trim();
  if(!allowedEmails.includes(email)) {
    hidePreloader();
    pushNotification('Ba a taba yin rigista da wannan imel din ba! A TauraronWasa', 'error');
    return;
  }
  try {
    await signInWithEmailAndPassword(auth, email, password);
    pushNotification('An shiga cikin nasara!', 'success');
  } catch (err) {
    pushNotification('Shiga ya fadi! Duba imel da kalmar sirri ku sake gwadawa', 'error');
    hidePreloader();
  }
};

logoutBtn.onclick = async () => {
  await signOut(auth);
  pushNotification('An fita cikin nasara!', 'success');
  setTimeout(() => location.reload(), 900);
};

// ==== FETCH NEWS FROM RSS/APIs ====
// We'll use rss2json api for demo (for production, use a backend CORS proxy)
async function fetchNewsRSS() {
  showPreloader();
  let allNews = [];
  for(const rss of newsRSSLinks) {
    try {
      const resp = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rss)}`);
      const data = await resp.json();
      if(data.items) allNews = allNews.concat(data.items);
    } catch(e) {}
  }
  // Remove duplicates by link/title
  let seen = new Set();
  allNews = allNews.filter(n => {
    let key = n.link || n.title;
    if(seen.has(key)) return false;
    seen.add(key);
    return true;
  });
  // Only show new news since lastFetchTimestamp
  let now = toNigeriaTime();
  let lastTime = lastFetchTimestamp ? new Date(lastFetchTimestamp) : new Date(now.getTime() - 2*24*60*60*1000);
  let newNews = allNews.filter(n => new Date(n.pubDate) > lastTime);
  // Save newTime as lastFetchTimestamp
  lastFetchTimestamp = now.toISOString();
  // Translate & display
  if(!newNews.length) {
    hidePreloader();
    pushNotification("Babu sabbin labarai a yanzu.", "success");
    return;
  }
  newsFeed.innerHTML = '';
  // Lazy load: render one by one
  for (const news of newNews.slice(0,20)) {
    await showNewsCard(news);
  }
  hidePreloader();
  pushNotification('An samo sabbin labarai na wasanni!', 'success');
}

// Show news with translation via OpenRouter API
async function showNewsCard(news) {
  let card = document.createElement('div');
  card.className = "news-card";
  card.innerHTML = `
    <div class="news-title">${news.title}</div>
    <div class="news-content">Ana fassara...</div>
    ${news.thumbnail ? `<img src="${news.thumbnail}" class="news-image" loading="lazy" alt="hoto">` : ''}
    <div class="news-meta">
      <span><i class="fas fa-calendar"></i> ${formatDate(news.pubDate)}</span>
      <a href="${news.link}" target="_blank" class="api-link"><i class="fas fa-link"></i> Duba asali</a>
    </div>
    <button class="main-btn approve-news-btn"><i class="fas fa-check"></i> Aproble</button>
  `;
  newsFeed.appendChild(card);

  // Translate news content/title to Hausa
  try {
    let openaiResp = await fetch('https://openrouter.ai/api/v1/chat/completions', {
      method: 'POST',
      headers: {
        Authorization: 'Bearer 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',
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        model: 'openai/gpt-4o',
        messages: [{
          role: 'user',
          content: `Fassara wannan labari zuwa Hausa mai inganci da sauki, ba tare da karyawa ko sabawa ba. Ka sake tsara shi kamar yadda manema labarai ke sanarwa ga jama'a. Ka hada da bayanin hoto ko bidiyo idan akwai: \n\n${news.title}\n${news.description || ''}`
        }]
      })
    });
    let result = await openaiResp.json();
    let hausaText = result.choices?.[0]?.message?.content?.trim() || 'An kasa fassara labarin.';
    card.querySelector('.news-content').innerText = hausaText;
  } catch (e) {
    card.querySelector('.news-content').innerText = 'An samu matsala wajen fassara labarin.';
  }

  // Approve button
  card.querySelector('.approve-news-btn').onclick = async () => {
    let postId = generateShortId();
    let postData = {
      postid: postId,
      Tile: news.title,
      test: card.querySelector('.news-content').innerText,
      photoLink1: news.thumbnail || '',
      photoLink2: '',
      videoaLink: '',
      see: 0,
      like: 0,
      postingTime: toNigeriaTime().toISOString(),
      Comment: { replyText: '', replyAudioLink: '', love: 0 }
    };
    await push(ref(db, 'posting'), postData);
    pushNotification('An adana labarin cikin nasara!', 'success');
    card.remove();
    fetchPosts();
  };
}

// ==== FETCH/SHOW POSTS FROM FIREBASE ====
function fetchPosts() {
  firebasePosts.innerHTML = '';
  onValue(ref(db, 'posting'), (snapshot) => {
    firebasePosts.innerHTML = '';
    let posts = [];
    snapshot.forEach(child => posts.unshift({ ...child.val(), key: child.key }));
    posts.forEach(post => appendPostCard(post));
  });
}

// ==== APPEND POST CARD / EDIT / DELETE / SAVE ====
function appendPostCard(post) {
  let card = document.createElement('div');
  card.className = 'post-card';
  card.setAttribute('data-postid', post.key);

  card.innerHTML = `
    <div class="post-title" spellcheck="false">${post.Tile}</div>
    <div class="post-content" spellcheck="false">${post.test}</div>
    ${post.photoLink1 ? `<img src="${post.photoLink1}" class="post-image" loading="lazy" alt="hoto">` : ''}
    ${post.photoLink2 ? `<img src="${post.photoLink2}" class="post-image" loading="lazy" alt="hoto">` : ''}
    ${post.videoaLink ? `<video src="${post.videoaLink}" class="post-video" controls></video>` : ''}
    <div class="post-meta">
      <span><i class="fas fa-eye"></i> ${post.see}</span>
      <span><i class="fas fa-heart"></i> ${post.like}</span>
      <span><i class="fas fa-clock"></i> ${formatDate(post.postingTime)}</span>
    </div>
    <div class="post-actions">
      <button class="icon-btn delete-btn" title="Goge"><i class="fas fa-xmark"></i></button>
      <button class="icon-btn edit-btn" title="Gyara"><i class="fas fa-hourglass"></i></button>
      <button class="icon-btn approve-btn" title="Aprobal"><i class="fas fa-check"></i></button>
    </div>
  `;
  firebasePosts.appendChild(card);

  // Delete
  card.querySelector('.delete-btn').onclick = async () => {
    await remove(ref(db, 'posting/' + post.key));
    card.remove();
    pushNotification('An goge post din.', 'success');
  };

  // Edit
  card.querySelector('.edit-btn').onclick = () => {
    if(card.classList.contains('editing')) return;
    card.classList.add('editing');
    let titleEl = card.querySelector('.post-title');
    let contentEl = card.querySelector('.post-content');
    titleEl.contentEditable = contentEl.contentEditable = "true";
    titleEl.focus();
    let saveBtn = document.createElement('button');
    saveBtn.className = 'save-edit-btn';
    saveBtn.innerText = "Ajiye";
    card.querySelector('.post-actions').appendChild(saveBtn);
    saveBtn.onclick = async () => {
      await update(ref(db, 'posting/' + post.key), {
        Tile: titleEl.innerText,
        test: contentEl.innerText
      });
      card.classList.remove('editing');
      titleEl.contentEditable = contentEl.contentEditable = "false";
      saveBtn.remove();
      pushNotification("An ajiye gyara!", "success");
    }
  };

  // Approve (no-op since already in DB)
  card.querySelector('.approve-btn').onclick = () => {
    pushNotification("Wannan post din an riga an adana shi!", "success");
  };
}

// ==== CREATE POST (MANUAL) ====
newPostForm.onsubmit = async (e) => {
  e.preventDefault();
  showPreloader();
  let Tile = newPostForm.postTitle.value.trim();
  let test = newPostForm.postText.value.trim();
  let photoLink1 = images[0] || '';
  let photoLink2 = images[1] || '';
  let videoaLink = videos[0] || '';
  // Validate
  if(!Tile || !test) {
    hidePreloader();
    pushNotification("Dole ne a cika dukkan filayen da ake bukata.", "error");
    return;
  }
  // Save post
  let postData = {
    postid: generateShortId(),
    Tile, test, photoLink1, photoLink2, videoaLink,
    see: 0, like: 0,
    postingTime: toNigeriaTime().toISOString(),
    Comment: { replyText: '', replyAudioLink: '', love: 0 }
  };
  await push(ref(db, 'posting'), postData);
  pushNotification("An tura post cikin nasara!", "success");
  hidePreloader();
  newPostForm.reset();
  images = []; videos = [];
  uploadedImages.innerHTML = '';
  uploadedVideos.innerHTML = '';
};

// ==== IMAGE/VIDEO UPLOAD HANDLING (IMGUR) ====
function uploadImage(file, cb) {
  let formData = new FormData();
  formData.append("image", file);
  fetch("https://api.imgur.com/3/image", {
    method: "POST",
    headers: { Authorization: "Client-ID 5acf7eff9c91660" },
    body: formData
  }).then(r=>r.json()).then(r=>{
    if(r?.data?.link) cb(r.data.link);
    else pushNotification("An kasa loda hoton!", "error");
  }).catch(()=>pushNotification("Kuskure wajen loda hoto!", "error"));
}
function uploadVideo(file, cb) {
  if(!isValidVideoSize(file)) {
    pushNotification("Bidiyon ya wuce 9MB!", "error");
    return;
  }
  let formData = new FormData();
  formData.append("video", file);
  fetch("https://api.imgur.com/3/upload", {
    method: "POST",
    headers: { Authorization: "Client-ID 5acf7eff9c91660" },
    body: formData
  }).then(r=>r.json()).then(r=>{
    if(r?.data?.link) cb(r.data.link);
    else pushNotification("An kasa loda bidiyo!", "error");
  }).catch(()=>pushNotification("Kuskure wajen loda bidiyo!", "error"));
}

// Handle image upload(s)
document.getElementById('imageUpload1').onchange = function() {
  let file = this.files[0];
  if(file) uploadImage(file, (link) => {
    images[0] = link;
    renderUploadedMedia();
  });
};
document.getElementById('imageUpload2').onchange = function() {
  let file = this.files[0];
  if(file) uploadImage(file, (link) => {
    images[1] = link;
    renderUploadedMedia();
  });
};
document.getElementById('videoUpload').onchange = function() {
  let file = this.files[0];
  if(file) uploadVideo(file, (link) => {
    videos[0] = link;
    renderUploadedMedia();
  });
};
// Render uploaded media thumbnails
function renderUploadedMedia() {
  uploadedImages.innerHTML = images.map((l,i)=>l?`<div class="upload-thumb" style="background:url('${l}') center/cover">
    <button class="remove-media" onclick="removeImage(${i})"><i class="fas fa-xmark"></i></button></div>`:'').join('');
  uploadedVideos.innerHTML = videos.map((l,i)=>l?`<div class="video-thumb"><video src="${l}" controls style="width:100%;height:100%"></video>
    <button class="remove-media" onclick="removeVideo(${i})"><i class="fas fa-xmark"></i></button></div>`:'').join('');
}
window.removeImage = (i) => { images.splice(i,1); renderUploadedMedia(); }
window.removeVideo = (i) => { videos.splice(i,1); renderUploadedMedia(); }

// Handle direct media link input
document.getElementById('mediaLink').onblur = function() {
  let link = this.value.trim();
  if(!link) return;
  if(link.match(/\.(jpg|jpeg|png|gif)$/i)) {
    images[0] = link;
    renderUploadedMedia();
  } else if(link.match(/\.(mp4|mov|avi)$/i)) {
    videos[0] = link;
    renderUploadedMedia();
  }
};

// ==== NEWS BUTTON ==== 
fetchNewsBtn.onclick = fetchNewsRSS;

// ==== INTERSECTION OBSERVER (Lazy Fade Up) ====
const observer = new IntersectionObserver((entries) => {
  for(const entry of entries) {
    if(entry.isIntersecting) entry.target.classList.add('fade-in');
  }
}, { threshold: .12 });
setTimeout(()=>{
  document.querySelectorAll('.news-card, .post-card').forEach(el=>observer.observe(el));
}, 2500);

// ==== PRELOADER HIDE ON LOAD ====
window.addEventListener('load', hidePreloader);

  </script>
</body>
</html>
